# OpenVPN Manager Wrapper

OpenVPN Manager Wrapper — это легковесная TypeScript-библиотека без зависимостей, обеспечивающая удобный доступ к 
OpenVPN Management Interface. Она позволяет подключаться к серверу, управлять клиентами и получать события в режиме реального времени.

Библиотека не имеет зависимостей – используется только стандартный функционал Node.js.
Методы можно заменить на аналоги для других рантаймов (Deno, Bun).\
Проект написан на TypeScript, поэтому вы получаете статическую типизацию и автодополнение в вашей IDE.

[Документация на английском](/README.md)

# Возможности
- События подключения и отключения клиентов
- Получение полного списка активных подключений
- Мониторинг трафика клиентов
- Отправка команд на OpenVPN сервер

# Быстрый старт
Создайте экземпляр `OpenvpnManager` и подключитесь к серверу:\
О том как настроить OpenVPN Manager читайте [здесь](./docs/Openvpn-manager.md) или в [официальной документации OpenVPN](https://openvpn.net/community-docs/community-articles/openvpn-2-6-manual.html#management-interface-options-177179)

## Подключение
```ts
// Инициализируем подключение к OpenVPN API
const api = new OpenvpnManager(
  {
    id: "srv1",         // Идентификатор сервера (любая строка)
    host: "127.0.0.1",  // Адрес до OpenVPN manager
    port: 7505,         // Порт до OpenVPN manager
    timeout: 5000,      // Таймаут подключения в ms (по умолчанию 5000)
  },
);

// Подключение
await api.connect();
```
На этом этапе соединение с OpenVPN установлено.

## Получение событий
Для получения событий подпишитесь на нужные события:
```ts
// Подключившеся клиент
api.on("client:connection", (client: ConnectionClient) => {
  // Обработка подключившегося клиента
})
    
// Получение списка клиентов
api.once("client:list", (clients: Cl) => {
    // Обработка списка клиентов. Метод сработает один раз
})
```
Полный список доступных событий приведён в разделе [События](#события)

# Параметры конструктора
Дополнительные параметры, доступные при создании экземпляра `OpenvpnManager`:

- `event` — собственный EventEmitter для обработки событий (по умолчанию создаётся внутренний эмиттер).
- `logger` — логгер для ведения логов (по умолчанию используется `console`).
```ts
// Импортируем хелпер для типизации
import { CustomEventType } from "openvpn-manager/event-responses.types";

// Создаём эмиттер
const emmiter = new EventEmitter<CustomEventType>();

const api = new OpenvpnManager(
  {
    id: "1",
    host: "127.0.0.1",
    port: 7505,
    timeout: 5000,
  },
  {
    event: emmiter, 	// Кастомный эмиттер событий
    logger: console, 	// По умолчанию используется console. Можно передать собственный логгер
  }
);
```

# События
Все события и интерфейсы можно посмотреть в файле с [типами](https://github.com/Leo5878/openvpn-manager/blob/main/src/event-responses.types.ts)

| Событие             | Тип                | Описание                                                      |
|---------------------|--------------------|---------------------------------------------------------------|
| `client:connection` | `ClientConnection` | Событие о подключении клиента                                 |
| `client:list`       | `Cl`               | Список подключённых клиентов                                  |
| `byte:count`        | `ByteCount`        | Информация о трафике клиента                                  |
| `client:disconnect` | `ClientDisconnect` | Возвращается массив из CommonName (_планируется дополнить_)   |
| `socket:error`      | `SocketError`      | Событие о возникновения ошибки с сокетом во время подключения |

## client:list

Событие **client:list** возвращает информацию о подключённых клиентах:

* CN (имя клиента)
* Реальный адрес (IP:порт)
* Виртуальный IP клиента
* Объём входящего и исходящего трафика
* Дата и время подключения

Подробнее в официальной документации:
[OpenVPN Management Interface Documentation](https://openvpn.net/community-resources/management-interface/)

## Отправка команд
Метод writeSocket позволяет отправлять команды напрямую в сокет OpenVPN Manager.\
Этот метод не выполняет дополнительной обработки данных, а просто передаёт строку команды. Каждая команда должна заканчиваться символами \r\n.

Пример:
```ts 
this.writeSocket("status 2\r\n"); // <- \r\n - обязательно в конце каждой команды
```
Чтобы обработать ответ, подпишитесь на глобальное событие data.\
Глобальное оно потому, что уведомляет
о всех событиях, что приходят от OpenVPN.
> [!NOTE]
> Это "сырой" метод, он ничего не делает дополнительно, только пишет в сокет команду.

Пример:
```ts
api.on("client:connection", (client: ConnectionClient) => {
  // Обработка подключившегося клиента
})
```
